const t=t=>"function"==typeof t,e=Object.prototype.toString,n=t=>"[object Object]"===e.call(t),o=t=>e.call(t),c=Object.keys,{hasOwnProperty:s}=Object.prototype,a=t=>{throw new Error(t)},r=Object.create(null);function i(e){n(e)||a("provider必须是一个Object");const{store:o,namespace:c="",component2:s=!1}=e;o&&t(o.getState)&&t(o.dispatch)&&t(o.subscribe)||a("store必须为Redux的Store实例对象"),r.__REDUX_BINDINGS_PROVIDER__={store:o,lifetimes:{page:["onLoad","onUnload"],component:["attached","detached"]},namespace:c}}function f(){return r.__REDUX_BINDINGS_PROVIDER__||a("请先设置provider"),r.__REDUX_BINDINGS_PROVIDER__}const u=()=>f().store,l=()=>f().store.getState(),p=()=>f().store.dispatch;function h(t){const{store:e}=f();let n=e.getState();return e.subscribe(()=>{const o=e.getState();t(o,n),n=o})}function g(t){const{store:e}=f(),n={};return Object.defineProperty(n,"value",{configurable:!1,enumerable:!0,get:()=>t(e.getState())}),n}function b(t,e){if(!Array.isArray(e)||e.length<1)return t;let n,o={};return function(c){return e.some(t=>o[t]!==c[t])&&(o=c,n=t(c)),n}}function d(t){const e=l(),o={};for(let c=0,a=t.length;c<a;c++){const a=t[c];switch(typeof a){case"string":s.call(e,a)&&(o[a]=e[a]);break;case"function":{const t=a(e);n(t)&&Object.assign(o,t);break}}}return o}function j(e,o){n(e)?function(e,n){const o=p(),s=c(e);for(let c=0,a=s.length;c<a;c++){const a=s[c],r=e[a];t(r)&&(n[a]=(...t)=>o(r.apply(null,t)))}}(e,o):t(e)&&function(t,e){const o=t(p());n(o)||a("mapDispatch函数必须返回一个对象"),Object.assign(e,o)}(e,o)}function y(t,e,n,s){const a=c(t),r=c(e),i=a.length,f=r.length;if(!(i<1&&f<1))if(i<1||f<1||i<f)n[s]=t;else{for(let e=0;e<f;e++){const o=r[e];if(a.indexOf(o)<0)return void(n[s]=t)}for(let c=0;c<i;c++){const i=a[c],f=t[i],u=`${s}.${i}`;if(r.indexOf(i)<0){n[u]=f;continue}const l=e[i];if(f!==l){const t=o(f);t!==o(l)?n[u]=f:"[object Object]"===t?y(f,l,n,u):"[object Array]"===t?O(f,l,n,u):n[u]=f}}}}function O(t,e,n,c){const s=t.length,a=e.length;if(!(s<1&&a<1))if(s<1||a<1||s<a)n[c]=t;else for(let r=0;r<s;r++){const s=t[r],i=`${c}[${r}]`;if(r>=a){n[i]=s;continue}const f=e[r];if(s!==f){const t=o(s);t!==o(f)?n[i]=s:"[object Object]"===t?y(s,f,n,i):"[object Array]"===t?O(s,f,n,i):n[i]=s}}}function m(t,e,n=""){const s=c(t),a=c(e),r=s.length,i=a.length;if(r<1&&i<1)return{};if(r<1||i<1)return n?{[n]:t}:t;const f={};for(let c=0;c<r;c++){const r=s[c],i=t[r],u=n?`${n}.${r}`:r;if(a.indexOf(r)<0){f[u]=i;continue}const l=e[r];if(i!==l){const t=o(i);t!==o(l)?f[u]=i:"[object Object]"===t?y(i,l,f,u):"[object Array]"===t?O(i,l,f,u):f[u]=i}}return f}const _=[];function D(){if(_.length<1)return;let t;for(;t=_.shift();){const e=m(t.updater,t.data,t.rootPath);c(e).length>0&&t.setData(e)}}function S(t,e){return h((o,s)=>{const a={};for(let t=0,c=e.length;t<c;t++){const c=e[t];switch(typeof c){case"string":o[c]!==s[c]&&(a[c]=o[c]);break;case"function":{const t=c(o);n(t)&&Object.assign(a,t);break}}}c(a).length>0&&function({id:t,data:e,setData:n},o){const c=_.find(e=>e.id===t);c?Object.assign(c.updater,o):_.push({id:t,rootPath:f().namespace,data:Object.assign({},e),updater:o,setData:n}),Object.assign(e,o),Promise.resolve().then(D)}(t,a)})}const I=Symbol("INSTANCE_ID");function R({type:t="page",mapState:e,mapDispatch:n,manual:o=!1}={}){"page"!==t&&"component"!==t&&a("type属性只能是page或component");const s="page"===t,{lifetimes:r,namespace:i}=f();return function(a){if(Array.isArray(e)&&e.length>0){const n=d(e);a.data=Object.assign(a.data||{},i?{[i]:n}:n);const o=new Map,[s,f]=r[t],u=a[s],l=a[f];a[s]=function(...t){const n=()=>i?this.data[i]:this.data,s=m(d(e),n(),i);c(s).length>0&&this.setData(s);const a=Symbol("instanceId"),r=S({id:a,data:n(),setData:this.setData.bind(this)},e);o.set(a,r),this[I]=a,u&&u.apply(this,t)},a[f]=function(){l&&l.apply(this);const t=this[I];if(o.has(t)){const e=o.get(t);o.delete(t),e()}}}if(n){const t=s?a:a.methods=a.methods||{};j(n,t)}return o?a:s?Page(a):Component(a)}}function P(t={}){return t.type="page",R(t)}function A(t={}){return t.type="component",R(t)}export{A as $component,P as $page,R as connect,i as setProvider,p as useDispatch,g as useRef,b as useSelector,l as useState,u as useStore,h as useSubscribe};
